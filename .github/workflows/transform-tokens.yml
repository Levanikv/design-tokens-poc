name: Transform Design Tokens

on:
  push:
    paths:
      - 'tokens/**'
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout design-tokens repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build tokens
        run: npm run build

      - name: Upload Kotlin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kotlin-tokens
          path: build/kotlin/
          retention-days: 30

      - name: Checkout Android repo
        uses: actions/checkout@v4
        with:
          repository: AccorECOM/AH_AND
          token: ${{ secrets.ANDROID_REPO_TOKEN }}
          ref: develop
          path: android-app

      - name: Copy tokens to Android repo
        run: |
          mkdir -p android-app/design/designsystem/library/src/main/kotlin/com/accor/designsystem/compose/
          cp build/kotlin/AccorColorPrimitives.kt android-app/design/designsystem/library/src/main/kotlin/com/accor/designsystem/compose/
          cp build/kotlin/AccorColorSemantics.kt android-app/design/designsystem/library/src/main/kotlin/com/accor/designsystem/compose/

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: android-app
          token: ${{ secrets.ANDROID_REPO_TOKEN }}
          commit-message: "chore: update design tokens from Figma"
          title: "Update Design Tokens"
          body: |
            Automated PR to update design tokens from Figma.

            **Source commit:** ${{ github.sha }}

            **Files updated:**
            - AccorColorPrimitives.kt
            - AccorColorSemantics.kt
          branch: update-design-tokens
          base: develop
          update-pull-request-method: update
          delete-branch: true
